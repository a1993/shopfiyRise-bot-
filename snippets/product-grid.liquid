{% comment %}
  通用商品网格组件
  用于展示商品列表，支持不同的布局样式
  
  参数说明:
  - products: 商品数组 (必需)
  - grid_style: 网格样式 ('crazy', 'flash', 'halloween', 'standard')
  - grid_class: 额外的 CSS class (可选)
  - card_style: 传递给商品卡片的样式
  - show_reviews: 是否显示评论
  - currency_symbol: 货币符号
  - discount_percent: 统一的折扣百分比 (可选)
  - section_blocks: section.blocks 数组 (用于遍历产品块)
  - filter_category: 过滤分类编号 (用于 flash-sale 和 halloween)
{% endcomment %}

{%- liquid
  assign grid_style = grid_style | default: 'standard'
  assign card_style = card_style | default: grid_style
-%}

<div class="product-grid product-grid--{{ grid_style }}{% if grid_class %} {{ grid_class }}{% endif %}">
  {% if section_blocks %}
    {% comment %} 使用 section.blocks 遍历 {% endcomment %}
    {% for block in section_blocks %}
      {% if block.type == 'product_item' %}
        {% comment %} 如果有分类过滤，检查是否属于当前分类 {% endcomment %}
        {% if filter_category %}
          {% assign parent_num = 0 %}
          {% if grid_style == 'flash' %}
            {% assign parent_num = block.settings.parent_tab_number | plus: 0 %}
          elsif grid_style == 'halloween' %}
            {% assign parent_num = block.settings.parent_category_number | plus: 0 %}
          {% endif %}
          
          {% if parent_num == filter_category %}
            {% assign product = block.settings.product %}
            {% if product %}
              {% render 'product-card',
                product: product,
                card_style: card_style,
                show_reviews: show_reviews,
                discount_percent: discount_percent,
                currency_symbol: currency_symbol,
                button_text: block.settings.button_text,
                shopify_attributes: block.shopify_attributes
              %}
            {% endif %}
          {% endif %}
        {% else %}
          {% comment %} 没有分类过滤，直接渲染 {% endcomment %}
          {% if grid_style == 'crazy' %}
            {% comment %} Crazy Weekend Sale 使用自定义字段 {% endcomment %}
            {% render 'product-card',
              product: nil,
              product_image: block.settings.product_image,
              product_title: block.settings.product_title,
              product_desc: block.settings.product_desc,
              product_url: block.settings.product_url,
              old_price: block.settings.old_price,
              new_price: block.settings.new_price,
              card_style: card_style,
              card_type: block.settings.card_type,
              badge_image: block.settings.badge_image,
              currency_symbol: currency_symbol,
              button_text: block.settings.button_text,
              shopify_attributes: block.shopify_attributes
            %}
          {% else %}
            {% assign product = block.settings.product %}
            {% if product %}
              {% render 'product-card',
                product: product,
                card_style: card_style,
                show_reviews: show_reviews,
                discount_percent: discount_percent,
                currency_symbol: currency_symbol,
                button_text: block.settings.button_text,
                shopify_attributes: block.shopify_attributes
              %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% elsif products %}
    {% comment %} 使用 products 数组遍历 {% endcomment %}
    {% for product in products %}
      {% render 'product-card',
        product: product,
        card_style: card_style,
        show_reviews: show_reviews,
        discount_percent: discount_percent,
        currency_symbol: currency_symbol,
        button_text: button_text
      %}
    {% endfor %}
  {% endif %}
</div>

