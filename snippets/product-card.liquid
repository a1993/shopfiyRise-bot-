{% comment %}
  通用商品卡片组件
  可用于各种促销活动页面的商品展示
  
  参数说明:
  - product: 商品对象 (必需)
  - card_style: 卡片样式 ('crazy', 'flash', 'halloween', 'standard')
  - card_type: 卡片类型 ('type1', 'type2' - 仅用于crazy样式)
  - show_reviews: 是否显示评论
  - discount_percent: 折扣百分比 (可选，用于显示折扣标签)
  - currency_symbol: 货币符号 (默认为 $)
  - button_text: 按钮文字 (默认为 Shop Now)
  - badge_image: 自定义徽章图片 (可选)
  - tag_image: 自定义标签图片 (可选)
  - product_url: 自定义商品链接 (可选，默认使用 product.url)
  - product_title: 自定义商品标题 (可选，默认使用 product.title)
  - product_desc: 商品描述 (可选)
  - old_price: 自定义原价 (可选)
  - new_price: 自定义折扣价 (可选)
  - shopify_attributes: Shopify属性 (用于主题编辑器)
{% endcomment %}

{%- liquid
  # 设置默认值
  assign card_style = card_style | default: 'standard'
  assign currency = currency_symbol | default: '$'
  assign btn_text = button_text | default: 'Shop Now'
  
  # 处理 URL 和标题
  if product_url
    assign url = product_url
  elsif product
    assign url = product.url
  else
    assign url = '#'
  endif
  
  if product_title
    assign title = product_title
  elsif product
    assign title = product.title
  else
    assign title = ''
  endif
  
  # 价格计算
  if old_price and new_price
    # 使用自定义价格
    assign original_price = old_price
    assign sale_price = new_price
    assign has_custom_price = true
  elsif product
    # 使用商品价格
    assign original_price = product.price
    assign sale_price = product.price
    assign has_custom_price = false
    
    # 如果有折扣百分比，计算折扣价
    if discount_percent and discount_percent > 0
      assign discount_decimal = discount_percent | times: 1.0 | divided_by: 100.0
      assign discount_amount = original_price | times: discount_decimal
      assign sale_price = original_price | minus: discount_amount
    endif
  else
    # 没有价格信息
    assign original_price = 0
    assign sale_price = 0
    assign has_custom_price = false
  endif
  
  # 判断是否有对比价格
  assign has_compare_price = false
  if has_custom_price and old_price != blank
    assign has_compare_price = true
  elsif product and product.compare_at_price > product.price
    assign has_compare_price = true
    assign original_price = product.compare_at_price
  endif
  
  # 计算折扣百分比（用于显示）
  if has_compare_price and discount_percent == blank
    assign discount_amount = original_price | minus: sale_price
    assign discount_percent = discount_amount | times: 100.0 | divided_by: original_price | round
  endif
  
  # 图片尺寸设置
  if card_style == 'crazy'
    if card_type == 'type2'
      assign img_width = 311
      assign img_height = 260
    else
      assign img_width = 630
      assign img_height = 254
    endif
  elsif card_style == 'halloween'
    assign img_width = 300
    assign img_height = 300
  else
    assign img_width = 400
    assign img_height = 400
  endif
-%}

<!-- Product Card -->
<a href="{{ url | default: '#' }}" 
   class="product-card product-card--{{ card_style }}{% if card_type %} product-card--{{ card_type }}{% endif %}"
   {{ shopify_attributes }}>
  
  <!-- Product Image -->
  <div class="product-card__image-wrapper">
    {%- liquid
      assign product_img = nil
      
      # 优先使用传入的 product_image（用于 crazy-weekend-sale 自定义图片）
      if product_image != blank
        assign product_img = product_image
      elsif product != blank and product.featured_image != blank
        assign product_img = product.featured_image
      endif
    -%}
    
    {% if product_img %}
      <img 
        src="{{ product_img | image_url: width: img_width }}"
        srcset="{{ product_img | image_url: width: img_width }} {{ img_width }}w,
                {{ product_img | image_url: width: img_width | times: 2 }} {{ img_width | times: 2 }}w"
        sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, {{ img_width }}px"
        alt="{{ title | escape }}"
        width="{{ img_width }}"
        height="{{ img_height }}"
        loading="lazy"
        class="product-card__image">
    {% else %}
      <div class="product-card__image product-card__image--placeholder">
        {{ 'product-1' | placeholder_svg_tag }}
      </div>
    {% endif %}
    
    <!-- Badges & Tags -->
    {% if card_style == 'crazy' %}
      <!-- Crazy Weekend Sale 样式 -->
      {% if badge_image != blank %}
        <img loading="lazy"
             src="{{ badge_image | image_url: width: 262 }}"
             alt="Discount Badge"
             width="262"
             height="93"
             class="product-card__badge-image">
      {% endif %}
      
    {% elsif card_style == 'flash' %}
      <!-- Flash Sale 样式 -->
      {% if discount_percent and discount_percent > 0 %}
        <div class="product-card__discount-badge">
          <span>{{ discount_percent }}%</span>
          <span class="product-card__discount-off">OFF</span>
        </div>
      {% endif %}
      {% if product %}
        {% if product.tags contains 'HOT' or product.tags contains 'hot' %}
          <div class="product-card__hot-tag">
            <span>HOT</span>
          </div>
        {% endif %}
      {% endif %}
      
    {% elsif card_style == 'halloween' %}
      <!-- Halloween Sale 样式 -->
      {% if tag_image != blank %}
        <img 
          src="{{ tag_image | image_url: width: 140 }}"
          alt="Sale Tag"
          width="140"
          height="34"
          class="product-card__tag-image"
          loading="lazy">
      {% else %}
        <div class="product-card__badges">
          {% if discount_percent and discount_percent > 0 %}
            <div class="product-card__badge product-card__badge--discount">
              <span>{{ discount_percent }}%</span>
              <span class="product-card__badge-off">OFF</span>
            </div>
          {% endif %}
          {% if product %}
            {% if product.tags contains 'HOT' or product.tags contains 'hot' %}
              <div class="product-card__badge product-card__badge--hot">HOT</div>
            {% elsif product.tags contains 'NEW' or product.tags contains 'new' %}
              <div class="product-card__badge product-card__badge--new">NEW</div>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </div>
  
  <!-- Product Info -->
  <div class="product-card__info">
    <!-- Title -->
    {% if title != blank %}
      <h3 class="product-card__title">{{ title }}</h3>
    {% endif %}
    
    <!-- Description (仅 crazy 样式) -->
    {% if card_style == 'crazy' and product_desc != blank %}
      <p class="product-card__desc">{{ product_desc }}</p>
    {% endif %}
    
    <!-- Reviews (仅 flash 和 halloween 样式) -->
    {% if show_reviews and product != blank %}
      {% if product.metafields.reviews.rating_count.value and product.metafields.reviews.rating_count.value > 0 %}
        {% if card_style == 'flash' %}
          <div class="product-card__reviews">
            {{ product.metafields.reviews.rating_count.value }} Review(s)
          </div>
        {% elsif card_style == 'halloween' %}
          <div class="product-card__reviews">
            <span class="product-card__rating">
              {{ product.metafields.reviews.rating.value | round: 1 }} ★
            </span>
            <span class="product-card__review-count">
              ({{ product.metafields.reviews.rating_count.value }})
            </span>
          </div>
        {% endif %}
      {% endif %}
    {% endif %}
    
    <!-- Price -->
    <div class="product-card__price">
      {% if card_style == 'crazy' %}
        <!-- Crazy Weekend Sale 价格布局 -->
        <div class="product-card__price-main">
          <div class="product-card__price-group">
            {% if has_compare_price %}
              <div class="product-card__price-old">
                {% if has_custom_price %}
                  {{ currency }}{{ original_price }}
                {% else %}
                  {{ original_price | money }}
                {% endif %}
              </div>
            {% endif %}
            <div class="product-card__price-new">
              {% if has_custom_price %}
                {{ currency }}{{ sale_price }}
              {% else %}
                {{ sale_price | money }}
              {% endif %}
            </div>
          </div>
          <div class="product-card__button">{{ btn_text }}</div>
        </div>
      {% else %}
        <!-- Flash & Halloween 价格布局 -->
        {% if has_compare_price %}
          <span class="product-card__price-compare">
            {% if has_custom_price %}
              {{ currency }}{{ original_price }}
            {% else %}
              {{ original_price | money }}
            {% endif %}
          </span>
        {% endif %}
        <span class="product-card__price-sale">
          {% if has_custom_price %}
            {{ currency }}{{ sale_price }}
          {% else %}
            {{ sale_price | money }}
          {% endif %}
        </span>
      {% endif %}
    </div>
    
    <!-- Shop Now Button (仅 halloween 样式) -->
    {% if card_style == 'halloween' %}
      <div class="product-card__shop-button">
        {{ btn_text }}
      </div>
    {% endif %}
  </div>
</a>

