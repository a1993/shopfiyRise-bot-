{% comment %}
  è‡ªå®šä¹‰ HTML å†…å®¹æ¨¡å— - æ”¯æŒ CSS Scoped æ ·å¼éš”ç¦»
  
  åŠŸèƒ½ï¼š
  - æ”¯æŒè‡ªå®šä¹‰ HTMLã€CSSã€JavaScript
  - CSS Scoped éš”ç¦»ï¼šç±»ä¼¼ Vue/CSS Modules çš„ä½œç”¨åŸŸéš”ç¦»
  - è‡ªåŠ¨å¤„ç†å†…è”å’Œå¤–éƒ¨æ ·å¼ï¼Œå®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
{% endcomment %}

{%- liquid
  assign section_id = 'custom-html-' | append: section.id
  assign container_type = section.settings.container_type
  assign custom_css = section.settings.custom_css
  assign custom_js = section.settings.custom_js
-%}

{%- style -%}
  #{{ section_id }} {
    padding-top: calc({{ section.settings.padding_top }}px * 0.75);
    padding-bottom: calc({{ section.settings.padding_bottom }}px * 0.75);
    {% if section.settings.background_color != blank %}
      background-color: {{ section.settings.background_color }};
    {% endif %}
    {% if section.settings.background_image != blank %}
      background-image: url('{{ section.settings.background_image | image_url: width: 1920 }}');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
    {% endif %}
  }

  @media screen and (min-width: 750px) {
    #{{ section_id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  {% if container_type == 'container' %}
    #{{ section_id }} .html-content-wrapper {
      max-width: {{ section.settings.container_width }}px;
      margin: 0 auto;
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% elsif container_type == 'container-fluid' %}
    #{{ section_id }} .html-content-wrapper {
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% endif %}

  /* è‡ªå®šä¹‰ CSS - è‡ªåŠ¨éš”ç¦»ä½œç”¨åŸŸ */
  {% if custom_css != blank %}
    #{{ section_id }} {
      {{ custom_css }}
    }
  {% endif %}
{%- endstyle -%}

<div id="{{ section_id }}" class="custom-html-section" {{ section.shopify_attributes }}>
  <div class="html-content-wrapper">
    {% if section.settings.section_title != blank %}
      <div class="section-title" style="text-align: {{ section.settings.title_alignment }}; margin-bottom: {{ section.settings.title_margin }}px;">
        <h2 style="font-size: {{ section.settings.title_size }}px; color: {{ section.settings.title_color }};">
          {{ section.settings.section_title }}
        </h2>
      </div>
    {% endif %}

    {% for block in section.blocks %}
      <div class="html-content-block" {{ block.shopify_attributes }}>
        {% case block.type %}
          {% when 'html' %}
            {{ block.settings.html_content }}
          {% when 'liquid' %}
            {{ block.settings.liquid_content }}
          {% when 'richtext' %}
            <div class="richtext-content">
              {{ block.settings.richtext_content }}
            </div>
          {% when 'code' %}
            <div class="code-block">
              {{ block.settings.code_content }}
            </div>
          {% when 'spacer' %}
            <div style="height: {{ block.settings.spacer_height }}px;"></div>
        {% endcase %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
{%- liquid
  assign use_shadow = section.settings.use_shadow_dom | default: false
-%}
(function() {
  const sectionId = '{{ section_id }}';
  const section = document.getElementById(sectionId);
  if (!section) return;

  const useShadowDOM = {{ use_shadow | json }};

  // CSS ä½œç”¨åŸŸå¤„ç†å‡½æ•°ï¼ˆç±»ä¼¼ Vue Scoped CSSï¼‰
  function addScopeToCSS(css, scopeId) {
    const scopeAttr = '[data-scope="' + scopeId + '"]';
    
    return css.replace(/([^{}@]+)(\s*\{)/g, function(match, selectors, brace) {
      if (match.trim().startsWith('}') || match.trim().startsWith('@')) {
        return match;
      }
      
      const selectorList = selectors.split(',');
      const scopedSelectors = selectorList.map(function(sel) {
        const trimmed = sel.trim();
        if (!trimmed || trimmed.includes('[data-scope=')) return sel;
        if (trimmed.match(/^(html|body|:root)$/)) return scopeAttr + ' ' + trimmed;
        return scopeAttr + ' ' + trimmed;
      });
      
      return scopedSelectors.join(',') + brace;
    });
  }
  
  if (useShadowDOM) {
    section.querySelectorAll('.html-content-block').forEach(function(block) {
      if (block.hasAttribute('data-scoped-applied')) return;
      
      try {
        const scopeId = 'scope_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const container = document.createElement('div');
        container.setAttribute('data-scope', scopeId);
        container.innerHTML = block.innerHTML;
        
        // å¤„ç†å†…è”æ ·å¼
        const styleTags = container.querySelectorAll('style');
        styleTags.forEach(function(styleTag) {
          styleTag.textContent = addScopeToCSS(styleTag.textContent, scopeId);
        });
        
        // å¤„ç†å¤–éƒ¨æ ·å¼
        const linkTags = container.querySelectorAll('link[rel="stylesheet"]');
        linkTags.forEach(function(linkTag) {
          const href = linkTag.href;
          fetch(href)
            .then(function(response) { return response.text(); })
            .then(function(css) {
              const newStyle = document.createElement('style');
              newStyle.textContent = addScopeToCSS(css, scopeId);
              linkTag.parentNode.replaceChild(newStyle, linkTag);
            })
            .catch(function(err) {
              console.warn('æ— æ³•åŠ è½½å¤–éƒ¨æ ·å¼:', href, err);
            });
        });
        
        block.innerHTML = '';
        block.appendChild(container);
        block.setAttribute('data-scoped-applied', 'true');
        
      } catch (e) {
        console.error('CSS Scoped å¤„ç†å¤±è´¥:', e);
      }
    });
    
    return;
  }

  // æ ‡å‡†æ¨¡å¼ï¼šå†…è”æ ·å¼è‡ªåŠ¨æ·»åŠ ä½œç”¨åŸŸ
  const styleTags = section.querySelectorAll('.html-content-block style');
  styleTags.forEach(function(styleTag) {
    try {
      let cssText = styleTag.textContent || styleTag.innerHTML;
      if (cssText.includes('/* auto-scoped */')) return;
      
      const scopedCss = cssText.replace(/([^{}@]+)(\s*\{)/g, function(match, selectors, brace) {
        if (match.trim().startsWith('}')) return match;
        const selectorList = selectors.split(',');
        const scopedSelectors = selectorList.map(function(sel) {
          const trimmed = sel.trim();
          if (!trimmed || trimmed.includes('#' + sectionId) || trimmed.startsWith('@')) return sel;
          return '\n  #' + sectionId + ' ' + trimmed;
        });
        return scopedSelectors.join(',') + brace;
      });
      
      styleTag.textContent = '/* auto-scoped */\n' + scopedCss;
    } catch (e) {
      console.warn('æ ·å¼éš”ç¦»å¤±è´¥:', e);
    }
  });
})();
</script>

{% if custom_js != blank %}
  <script>
    (function() {
      {{ custom_js }}
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "è‡ªå®šä¹‰ HTML å†…å®¹",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "æ ‡é¢˜è®¾ç½®"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "åˆ†åŒºæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "æ ‡é¢˜å­—ä½“å¤§å°",
      "default": 32
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "æ ‡é¢˜é¢œè‰²",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "æ ‡é¢˜å¯¹é½",
      "options": [
        { "value": "left", "label": "å·¦å¯¹é½" },
        { "value": "center", "label": "å±…ä¸­" },
        { "value": "right", "label": "å³å¯¹é½" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "title_margin",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "æ ‡é¢˜ä¸‹è¾¹è·",
      "default": 40
    },
    {
      "type": "header",
      "content": "å®¹å™¨è®¾ç½®"
    },
    {
      "type": "select",
      "id": "container_type",
      "label": "å®¹å™¨ç±»å‹",
      "options": [
        { "value": "full-width", "label": "å…¨å®½ï¼ˆæ— å®¹å™¨ï¼‰" },
        { "value": "container", "label": "å›ºå®šå®½åº¦å®¹å™¨" },
        { "value": "container-fluid", "label": "æµå¼å®¹å™¨" }
      ],
      "default": "container"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 800,
      "max": 1920,
      "step": 20,
      "unit": "px",
      "label": "å®¹å™¨æœ€å¤§å®½åº¦",
      "default": 1180,
      "info": "ä»…åœ¨é€‰æ‹©å›ºå®šå®½åº¦å®¹å™¨æ—¶ç”Ÿæ•ˆ"
    },
    {
      "type": "range",
      "id": "container_padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "å®¹å™¨å·¦å³å†…è¾¹è·",
      "default": 15
    },
    {
      "type": "header",
      "content": "èƒŒæ™¯è®¾ç½®"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "èƒŒæ™¯å›¾ç‰‡"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "èƒŒæ™¯é¢œè‰²"
    },
    {
      "type": "header",
      "content": "å†…è¾¹è·"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸Šå†…è¾¹è·",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸‹å†…è¾¹è·",
      "default": 0
    },
    {
      "type": "header",
      "content": "æ ·å¼éš”ç¦»è®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "use_shadow_dom",
      "label": "å¯ç”¨ CSS Scoped æ ·å¼éš”ç¦»",
      "default": false
    },
    {
      "type": "header",
      "content": "è‡ªå®šä¹‰æ ·å¼å’Œè„šæœ¬"
    },
    {
      "type": "html",
      "id": "custom_css",
      "label": "è‡ªå®šä¹‰ CSS",
      "info": "âœ… æ ·å¼ä¼šè‡ªåŠ¨éš”ç¦»åˆ°å½“å‰ section"
    },
    {
      "type": "html",
      "id": "custom_js",
      "label": "è‡ªå®šä¹‰ JavaScript"
    }
  ],
  "blocks": [
    {
      "type": "html",
      "name": "HTML ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "html_content",
          "label": "HTML å†…å®¹",
          "info": "ğŸ’¡ æ”¯æŒå¼•å…¥å¤–éƒ¨åº“ï¼ˆå¦‚ UIkitï¼‰ï¼Œå¯ç”¨ CSS Scoped åæ ·å¼ä¼šè‡ªåŠ¨éš”ç¦»"
        }
      ]
    },
    {
      "type": "liquid",
      "name": "Liquid ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "liquid_content",
          "label": "Liquid å†…å®¹"
        }
      ]
    },
    {
      "type": "richtext",
      "name": "å¯Œæ–‡æœ¬",
      "settings": [
        {
          "type": "richtext",
          "id": "richtext_content",
          "label": "å¯Œæ–‡æœ¬å†…å®¹"
        }
      ]
    },
    {
      "type": "code",
      "name": "åŸå§‹ä»£ç ",
      "settings": [
        {
          "type": "html",
          "id": "code_content",
          "label": "ä»£ç å†…å®¹"
        }
      ]
    },
    {
      "type": "spacer",
      "name": "é—´è·",
      "settings": [
        {
          "type": "range",
          "id": "spacer_height",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "label": "é—´è·é«˜åº¦",
          "default": 40
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "è‡ªå®šä¹‰ HTML å†…å®¹",
      "blocks": [
        {
          "type": "html"
        }
      ]
    }
  ]
}
{% endschema %}

