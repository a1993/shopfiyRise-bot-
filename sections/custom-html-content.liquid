{% comment %}
  è‡ªå®šä¹‰ HTML å†…å®¹æ¨¡å— - çµæ´»å¯¼å…¥è‡ªå®šä¹‰ä»£ç 
  
  åŠŸèƒ½ï¼š
  - æ”¯æŒå¯¼å…¥è‡ªå®šä¹‰ HTML ä»£ç 
  - å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ CSS
  - å¯ä»¥æ·»åŠ è‡ªå®šä¹‰ JavaScript
  - æ”¯æŒå¤šä¸ªå†…å®¹å—
  - å®Œå…¨è‡ªç”±çš„å¸ƒå±€æ§åˆ¶
  
  âš ï¸ æ ·å¼éš”ç¦»åŠŸèƒ½ï¼š
  - å†…è” <style> æ ‡ç­¾ä¼šè‡ªåŠ¨æ·»åŠ ä½œç”¨åŸŸï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€
  - å¤–éƒ¨ CSS åº“ï¼ˆ<link> æ ‡ç­¾ï¼‰éœ€è¦å¯ç”¨ "Shadow DOM éš”ç¦»" æ¥é˜²æ­¢æ±¡æŸ“
  - è‡ªå®šä¹‰ CSS è®¾ç½®ä¸­çš„æ ·å¼ä¼šè‡ªåŠ¨ä½¿ç”¨ CSS åµŒå¥—éš”ç¦»
  
  ğŸ’¡ ä½¿ç”¨å¤–éƒ¨åº“ï¼ˆå¦‚ UIkit, Bootstrapï¼‰æ—¶ï¼š
  1. åœ¨è®¾ç½®ä¸­å¯ç”¨ "Shadow DOM å®Œå…¨éš”ç¦»"
  2. æˆ–å‹¾é€‰ "ç§»é™¤å¤–éƒ¨ CSS é“¾æ¥" å¹¶è‡ªå·±å†™æ ·å¼
  3. æŸ¥çœ‹æ§åˆ¶å°ä¼šæœ‰è­¦å‘Šæç¤º
  
  è¯¦ç»†æ–‡æ¡£ï¼šsnippets/EXTERNAL-CSS-ISOLATION-GUIDE.md
{% endcomment %}

{%- liquid
  assign section_id = 'custom-html-' | append: section.id
  assign container_type = section.settings.container_type
  assign custom_css = section.settings.custom_css
  assign custom_js = section.settings.custom_js
-%}

{%- style -%}
  #{{ section_id }} {
    padding-top: calc({{ section.settings.padding_top }}px * 0.75);
    padding-bottom: calc({{ section.settings.padding_bottom }}px * 0.75);
    {% if section.settings.background_color != blank %}
      background-color: {{ section.settings.background_color }};
    {% endif %}
    {% if section.settings.background_image != blank %}
      background-image: url('{{ section.settings.background_image | image_url: width: 1920 }}');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
    {% endif %}
  }

  @media screen and (min-width: 750px) {
    #{{ section_id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  {% if container_type == 'container' %}
    #{{ section_id }} .html-content-wrapper {
      max-width: {{ section.settings.container_width }}px;
      margin: 0 auto;
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% elsif container_type == 'container-fluid' %}
    #{{ section_id }} .html-content-wrapper {
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% endif %}

  /* è‡ªå®šä¹‰ CSS - è‡ªåŠ¨éš”ç¦»ä½œç”¨åŸŸ */
  {% if custom_css != blank %}
    /* å°†æ‰€æœ‰è‡ªå®šä¹‰æ ·å¼è‡ªåŠ¨é™åˆ¶åœ¨å½“å‰ section å†… */
    /* ç¤ºä¾‹ï¼šç”¨æˆ·å†™ h1 { color: red; } ä¼šè‡ªåŠ¨å˜æˆ #{{ section_id }} h1 { color: red; } */
    #{{ section_id }} {
      {{ custom_css }}
    }
  {% endif %}
{%- endstyle -%}

<div id="{{ section_id }}" class="custom-html-section custom-scoped-section" {{ section.shopify_attributes }}>
  <div class="html-content-wrapper">
    {% if section.settings.section_title != blank %}
      <div class="section-title" style="text-align: {{ section.settings.title_alignment }}; margin-bottom: {{ section.settings.title_margin }}px;">
        <h2 style="font-size: {{ section.settings.title_size }}px; color: {{ section.settings.title_color }};">
          {{ section.settings.section_title }}
        </h2>
      </div>
    {% endif %}

    {% for block in section.blocks %}
      <div class="html-content-block html-block-{{ block.type }}" {{ block.shopify_attributes }}>
        {% case block.type %}
          
          {% when 'html' %}
            {{ block.settings.html_content }}
          
          {% when 'liquid' %}
            {% comment %} æ”¯æŒ Liquid ä»£ç  {% endcomment %}
            {{ block.settings.liquid_content }}
          
          {% when 'richtext' %}
            <div class="richtext-content">
              {{ block.settings.richtext_content }}
            </div>
          
          {% when 'code' %}
            {% comment %} åŸå§‹ä»£ç å—ï¼Œä¸åšä»»ä½•å¤„ç† {% endcomment %}
            <div class="code-block">
              {{ block.settings.code_content }}
            </div>

          {% when 'spacer' %}
            <div style="height: {{ block.settings.spacer_height }}px;"></div>

        {% endcase %}
      </div>
    {% endfor %}
  </div>
</div>

<!-- è‡ªåŠ¨æ ·å¼éš”ç¦»è„šæœ¬ï¼šå¤„ç† HTML å—ä¸­çš„ style å’Œ link æ ‡ç­¾ -->
<script>
(function() {
  const sectionId = '{{ section_id }}';
  const section = document.getElementById(sectionId);
  
  if (!section) return;
  
  const useShadowDOM = {{ section.settings.use_shadow_dom | default: false }};
  
  // ==================== Shadow DOM å®Œå…¨éš”ç¦»æ¨¡å¼ ====================
  if (useShadowDOM) {
    console.log('ğŸ”’ å¯ç”¨ Shadow DOM å®Œå…¨éš”ç¦»æ¨¡å¼');
    
    const htmlBlocks = section.querySelectorAll('.html-content-block');
    htmlBlocks.forEach(function(block) {
      // è·³è¿‡å·²ç»å¤„ç†è¿‡çš„
      if (block.hasAttribute('data-shadow-dom-applied')) return;
      
      try {
        // åˆ›å»ºä¸€ä¸ªå®¹å™¨
        const container = document.createElement('div');
        container.className = 'shadow-dom-container';
        
        // è·å–åŸå§‹HTMLå†…å®¹
        const originalContent = block.innerHTML;
        
        // åˆ›å»º Shadow DOM
        const shadowRoot = container.attachShadow({ mode: 'open' });
        
        // å°†å†…å®¹ç§»åˆ° Shadow DOM ä¸­
        shadowRoot.innerHTML = originalContent;
        
        // æ›¿æ¢åŸå§‹å†…å®¹
        block.innerHTML = '';
        block.appendChild(container);
        block.setAttribute('data-shadow-dom-applied', 'true');
        
        console.log('âœ… Shadow DOM éš”ç¦»æˆåŠŸ');
      } catch (e) {
        console.error('âŒ Shadow DOM åˆ›å»ºå¤±è´¥:', e);
      }
    });
    
    return; // Shadow DOM æ¨¡å¼ä¸‹ä¸éœ€è¦ä¸‹é¢çš„å¤„ç†
  }
  
  // ==================== æ ‡å‡†æ¨¡å¼ï¼šæ£€æµ‹å’Œå¤„ç†å¤–éƒ¨æ ·å¼ ====================
  
  // 1. æ£€æµ‹å¤–éƒ¨ link æ ‡ç­¾ï¼ˆä¼šæ±¡æŸ“å…¨å±€æ ·å¼ï¼‰
  const externalLinks = section.querySelectorAll('.html-content-block link[rel="stylesheet"]');
  if (externalLinks.length > 0) {
    console.warn('âš ï¸ æ£€æµ‹åˆ°å¤–éƒ¨CSSåº“ï¼è¿™äº›æ ·å¼ä¼šå½±å“æ•´ä¸ªç½‘ç«™ï¼š');
    externalLinks.forEach(function(link) {
      console.warn('  - ' + link.href);
    });
    console.warn('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šåœ¨ section è®¾ç½®ä¸­å¯ç”¨ "Shadow DOM éš”ç¦»æ¨¡å¼"');
    
    // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè­¦å‘Šï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
    if (window.Shopify && window.Shopify.designMode) {
      const warning = document.createElement('div');
      warning.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px; color: #856404;';
      warning.innerHTML = '<strong>âš ï¸ æ ·å¼æ±¡æŸ“è­¦å‘Šï¼š</strong> æ£€æµ‹åˆ° ' + externalLinks.length + ' ä¸ªå¤–éƒ¨CSSåº“ï¼Œå¯èƒ½å½±å“å…¨ç«™æ ·å¼ã€‚<br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong>å¯ç”¨ "Shadow DOM éš”ç¦»æ¨¡å¼"';
      section.insertBefore(warning, section.firstChild);
    }
  }
  
  // 2. å¤„ç†å†…è” style æ ‡ç­¾
  const styleTags = section.querySelectorAll('.html-content-block style');
  
  styleTags.forEach(function(styleTag) {
    try {
      let cssText = styleTag.textContent || styleTag.innerHTML;
      
      // è·³è¿‡å·²ç»å¤„ç†è¿‡çš„æ ·å¼
      if (cssText.includes('/* auto-scoped */')) return;
      
      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ·»åŠ ä½œç”¨åŸŸ
      const scopedCss = cssText.replace(
        /([^{}@]+)(\s*\{)/g,
        function(match, selectors, brace) {
          // è·³è¿‡ @è§„åˆ™çš„å†…å®¹éƒ¨åˆ†
          if (match.trim().startsWith('}')) {
            return match;
          }
          
          // åˆ†å‰²å¤šä¸ªé€‰æ‹©å™¨ï¼ˆé€—å·åˆ†éš”ï¼‰
          const selectorList = selectors.split(',');
          const scopedSelectors = selectorList.map(function(sel) {
            const trimmed = sel.trim();
            
            // è·³è¿‡ç©ºé€‰æ‹©å™¨
            if (!trimmed) return sel;
            
            // è·³è¿‡å·²ç»æœ‰ä½œç”¨åŸŸçš„
            if (trimmed.includes('#' + sectionId)) return sel;
            
            // è·³è¿‡ @è§„åˆ™ï¼ˆ@media, @keyframes ç­‰ï¼‰
            if (trimmed.startsWith('@')) return sel;
            
            // æ·»åŠ ä½œç”¨åŸŸå‰ç¼€
            return '\n  #' + sectionId + ' ' + trimmed;
          });
          
          return scopedSelectors.join(',') + brace;
        }
      );
      
      // æ·»åŠ æ ‡è®°ï¼Œé¿å…é‡å¤å¤„ç†
      styleTag.textContent = '/* auto-scoped */\n' + scopedCss;
      
    } catch (e) {
      console.warn('âš ï¸ æ ·å¼è‡ªåŠ¨éš”ç¦»å¤±è´¥:', e);
    }
  });
  
  // 3. ç§»é™¤æˆ–éš”ç¦»å¤–éƒ¨linkæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œéœ€è¦å¯ç”¨ï¼‰
  if ({{ section.settings.remove_external_css | default: false }}) {
    externalLinks.forEach(function(link) {
      console.warn('ğŸ—‘ï¸ å·²ç§»é™¤å¤–éƒ¨CSS:', link.href);
      link.remove();
    });
  }
  
})();
</script>

{% if custom_js != blank %}
  <script>
    (function() {
      // è‡ªå®šä¹‰ JavaScript ä»£ç ä¹Ÿåœ¨å‡½æ•°ä½œç”¨åŸŸå†…ï¼Œé¿å…æ±¡æŸ“å…¨å±€
      {{ custom_js }}
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "è‡ªå®šä¹‰ HTML å†…å®¹",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "æ ‡é¢˜è®¾ç½®"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "åˆ†åŒºæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "æ ‡é¢˜å­—ä½“å¤§å°",
      "default": 32
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "æ ‡é¢˜é¢œè‰²",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "æ ‡é¢˜å¯¹é½",
      "options": [
        { "value": "left", "label": "å·¦å¯¹é½" },
        { "value": "center", "label": "å±…ä¸­" },
        { "value": "right", "label": "å³å¯¹é½" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "title_margin",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "æ ‡é¢˜ä¸‹è¾¹è·",
      "default": 40
    },
    {
      "type": "header",
      "content": "å®¹å™¨è®¾ç½®"
    },
    {
      "type": "select",
      "id": "container_type",
      "label": "å®¹å™¨ç±»å‹",
      "options": [
        { "value": "full-width", "label": "å…¨å®½ï¼ˆæ— å®¹å™¨ï¼‰" },
        { "value": "container", "label": "å›ºå®šå®½åº¦å®¹å™¨" },
        { "value": "container-fluid", "label": "æµå¼å®¹å™¨" }
      ],
      "default": "container"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 800,
      "max": 1920,
      "step": 20,
      "unit": "px",
      "label": "å®¹å™¨æœ€å¤§å®½åº¦",
      "default": 1180,
      "info": "ä»…åœ¨é€‰æ‹©å›ºå®šå®½åº¦å®¹å™¨æ—¶ç”Ÿæ•ˆ"
    },
    {
      "type": "range",
      "id": "container_padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "å®¹å™¨å·¦å³å†…è¾¹è·",
      "default": 15
    },
    {
      "type": "header",
      "content": "èƒŒæ™¯è®¾ç½®"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "èƒŒæ™¯å›¾ç‰‡"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "èƒŒæ™¯é¢œè‰²"
    },
    {
      "type": "header",
      "content": "å†…è¾¹è·"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸Šå†…è¾¹è·",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸‹å†…è¾¹è·",
      "default": 0
    },
    {
      "type": "header",
      "content": "æ ·å¼éš”ç¦»è®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "use_shadow_dom",
      "label": "å¯ç”¨ Shadow DOM å®Œå…¨éš”ç¦»",
      "default": false,
      "info": "ğŸ”’ æ¨èï¼šå½“ä½¿ç”¨å¤–éƒ¨CSSåº“ï¼ˆå¦‚ UIkitã€Bootstrapï¼‰æ—¶å¯ç”¨ã€‚å®Œå…¨éš”ç¦»æ ·å¼ï¼Œä½†å¯èƒ½å½±å“æŸäº› JavaScript äº¤äº’"
    },
    {
      "type": "checkbox",
      "id": "remove_external_css",
      "label": "ç§»é™¤å¤–éƒ¨ CSS é“¾æ¥",
      "default": false,
      "info": "âš ï¸ å¼ºåˆ¶ç§»é™¤ HTML ä¸­çš„ <link> æ ‡ç­¾ï¼Œé˜²æ­¢å¤–éƒ¨æ ·å¼æ±¡æŸ“å…¨å±€ã€‚ä»…åœ¨ä¸ä½¿ç”¨ Shadow DOM æ—¶ç”Ÿæ•ˆ"
    },
    {
      "type": "header",
      "content": "è‡ªå®šä¹‰æ ·å¼å’Œè„šæœ¬"
    },
    {
      "type": "html",
      "id": "custom_css",
      "label": "è‡ªå®šä¹‰ CSS",
      "info": "âœ… æ ·å¼ä¼šè‡ªåŠ¨éš”ç¦»åˆ°å½“å‰ sectionï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ å‰ç¼€ã€‚ç›´æ¥å†™ï¼šh1 { color: red; } å³å¯"
    },
    {
      "type": "html",
      "id": "custom_js",
      "label": "è‡ªå®šä¹‰ JavaScript",
      "info": "ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨ document.querySelector('.custom-scoped-section') æ¥é™åˆ¶æ“ä½œèŒƒå›´"
    }
  ],
  "blocks": [
    {
      "type": "html",
      "name": "HTML ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "html_content",
          "label": "HTML å†…å®¹",
          "info": "âš ï¸ å¦‚æœåŒ…å«å¤–éƒ¨CSSåº“ï¼ˆ<link>æ ‡ç­¾ï¼‰ï¼Œè¯·å¯ç”¨ Shadow DOM éš”ç¦»æ¨¡å¼ï¼Œå¦åˆ™ä¼šæ±¡æŸ“å…¨å±€æ ·å¼ã€‚å†…è”<style>æ ‡ç­¾ä¼šè‡ªåŠ¨éš”ç¦»ã€‚"
        }
      ]
    },
    {
      "type": "liquid",
      "name": "Liquid ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "liquid_content",
          "label": "Liquid å†…å®¹",
          "info": "å¯ä»¥ä½¿ç”¨ Liquid è¯­æ³•å’Œå˜é‡"
        }
      ]
    },
    {
      "type": "richtext",
      "name": "å¯Œæ–‡æœ¬",
      "settings": [
        {
          "type": "richtext",
          "id": "richtext_content",
          "label": "å¯Œæ–‡æœ¬å†…å®¹"
        }
      ]
    },
    {
      "type": "code",
      "name": "åŸå§‹ä»£ç ",
      "settings": [
        {
          "type": "html",
          "id": "code_content",
          "label": "ä»£ç å†…å®¹",
          "info": "å®Œå…¨ä¸å¤„ç†çš„åŸå§‹å†…å®¹"
        }
      ]
    },
    {
      "type": "spacer",
      "name": "é—´è·",
      "settings": [
        {
          "type": "range",
          "id": "spacer_height",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "label": "é—´è·é«˜åº¦",
          "default": 40
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "è‡ªå®šä¹‰ HTML å†…å®¹",
      "blocks": [
        {
          "type": "html"
        }
      ]
    }
  ]
}
{% endschema %}

